{% load static %}

<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Login</title>
            <meta charset="UTF-8">
            <link href="{% static 'newsvendor/index.css' %}" rel="stylesheet">
            <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
            <meta name="viewport" content="width=device-width, initial-scale=1">

    </head>

    <body>
        <section id='main'>

            <form>
                {% csrf_token %}
            <section id=first >
                <div class="logo">
                   <p><h1 style="text-align: left; color: rgb(10, 10, 10);font-style:italic;">Game 2
                    <img src="{% static 'newsvendor/logo.png' %}"  alt="logo" style="vertical-align:middle;float: right;"></h1></p>
                </div>

                <div class="topnav">
                   <p> </p>
                </div>

                <div>
                    <h1 style="font-style:italic;">Thanks for accepting our request!</h1>
                </div>


                <div class="intro">
                    <h3>
                        Introduction:Task Decomposition and Newsvendor Decision Making
                    </h3>

                </div>
                <div>
                    <button onclick="document.getElementById('ethics').style.display='block'" style="width:auto;">Read Ethics</button>
                </div>
                <section id='ethics' class="modal">
                    <div class="modal-content">
                            <h2>Ethics </h2>
                        <div style="border:3px solid rgb(0, 183, 255) ;margin: auto;">
                            <p>All aspects of this study have been approved by the IITB Institute Ethics Committee, vide approval number IITB-IEC/2019/007. The informed consent form and task and incentive details have been provided by email. Your participation in the research is optional; we will use your data only if you consent to it here.</p>                        </div>
                        </div>
                        <div>
                            <button onclick="document.getElementById('ethics').style.display='none'" style="width:auto;">Close</button>
                        </div>
                    </div>
                </section>
                <div>
                    <h4>This survey takes approximately 5 mins.</h4>
                </div>
                <div class="footer">
                    <h3><label for="email">Enter your Email:</label>
                    <input type="email" id="email" name="email">
                    <p><button id="firstsubmit" style="width:auto;">Next</button></p>
                    </h3>
                </div>
            </section>

            <section id="second">
                <div class="logo">
                    <p><h1 style="text-align: left; color: rgb(10, 10, 10);font-style:italic;">Game 2
                     <img src="{% static 'newsvendor/logo.png' %}"  alt="logo" style="vertical-align:middle;float: right;"></h1></p>
                 </div>

                 <div class="topnav">
                    <p> </p>
                 </div>

                <h1 style="text-align: center;">Demographics</h1>

                <div class="card">
                    <img src={% static 'newsvendor/demographics1.png' %} alt="Demographics" style="width:100%">
                    <div class="container">
                        <label for="name">Enter your Name</label>
                        <input type="text" id="name" name="name">
                        <div class="row">
                            <div class="column">
                                <div>
                                <p><label for="gender">Please select your gender:</label></p>
                                <select id="gender" name="gender"  >
                                    <option disabled selected value> -- select an option -- </option>
                                    <option value="male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                  </select>
                                </div>

                                <div>
                                 <p><label for="gender">Please select your age:</label></p>
                                 <input type="number" id="age" name="age" min = "1">
                                  <!--<select id="age" name="age">
                                    <option disabled selected value> -- select an option -- </option>
                                      <option value="age1">0 - 30</option>
                                      <option value="age2">31 - 60</option>
                                      <option value="age3">61 - 100</option>
                                    </select> -->
                                </div>

                            </div>
                            <div class="column">
                                <div>
                               <p><label for="organisation">Please select your organisation:</label></p>
                                <select id="organisation" name="organisation">
                                    <option disabled selected value> -- select an option -- </option>
                                    <option value="Management">Management</option>
                                    <option value="Engineering">Engineering</option>
                                    <option value="Other">Other</option>
                                  </select>
                                </div>
                                <div>

                                <p> <label for="designation">Please select your designation:</label></p>
                                <select id="designation" name="designation">
                                    <option disabled selected value> -- select an option -- </option>
                                    <option value="Student">Student</option>
                                    <option value="Professor">Professor</option>
                                    <option value="Other">Other</option>
                                  </select>
                                </div>
                            </div>
                        </div>
                    </div>
                  </div>


                <p><button id="secondsubmit" style="width:auto;">Next</button></p>
            </section>

            <section id="third">

                <div class="logo">
                    <p><h1 style="text-align: left; color: rgb(10, 10, 10);font-style:italic;">Game 2
                     <img src="{% static 'newsvendor/logo.png' %}"  alt="logo" style="vertical-align:middle;float: right;"></h1></p>
                 </div>

                 <div class="topnav">
                    <p> </p>
                 </div>


                <div style="align-content:left;">
                    <h1><p><label style="text-align: left;">Round :  </label><label id="round" style="text-align:left">1</label></p></h1>
                </div>
                <div class="row">
                    <div class="column">

                        <div class="card">
                            <div id="plot" style="max-width:600px;max-height:500px;"></div>
                            <div id="even">
                               <!-- <table style="width:100%; align-content: flex-start;">
                                    <tr>
                                        <td>
                                            <h4> <label>Underage Cost:</label>
                                                <p> <label id="CU">CU</label></p></h4>
                                        </td>
                                        <td>
                                            <h4><label>Overage Cost:</label>
                                                <p><label id="CO">CO</label></p></h4>
                                    </td>
                                    </tr>
                                </table>-->
                            </div>
                            <div class="container">

                            </div>
                          </div>


                    </div>


                    <div class="column" >

                        <div class="card">
                             <table style="width:100%; align-content: flex-start;">
                                    <tr>
                                        <td>
                                            <h4> <label>Underage Cost:</label>
                                                <p> <label id="CU">CU</label></p></h4>
                                        </td>
                                        <td>
                                            <h4><label>Overage Cost:</label>
                                                <p><label id="CO">CO</label></p></h4>
                                    </td>
                                    </tr>
                                </table>
                            <table style="width:100%;">

                                <tr>

                                    <td>
                                        <h3><p><label for="forecast">Mean Demand </label></p>
                                            <p><input type="number" style="height:30px;"  id="meanValue" name="meanValue" readonly></p></h3>
                                    </td>
                                    <td>
                                        <h3><p><label for="LB">Standard Deviation</label></p><p>
<!--                                            <input type="number" id="LB" name="LB" onchange="calculate()"> -->
                                           <input type="number" style="height:30px;" id="deviationValue" name="deviationValue" readonly>
                                            </p></h3>
                                    </td>
                                </tr>
                                    <td>
                                        <h3><label for="UB">Instock Probability</label></h3> : <label style="font-size: 12px;">The probability that you have enough stock to meet the demand completely</label><p>
                                            <input type="number" id="UB" name="UB" style="border:2px solid #008000;height:30px; width:225px;" onclick="show_cost()" >
                                            </p>
                                    </td>
<!--                                    <td>-->
<!--                                        <h3><p><label for="fill">Target Fill Rate</label></p>-->
<!--                                            <p><input type="number" id="fill" name="target_fil_rate" ></p></h3>-->
<!--                                    </td>-->
                                </tr>
                            </table>
                            <div class="container">
                                <p><button id="roundSub" style="width:auto;">Next</button></p>
                            </div>
                          </div>
                        </table>
                    </div>

                </div>

            </section>
            </form>

        </section>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script>
            // let pic = ["{% static 'newsvendor/plots/1.png' %}","{% static 'newsvendor/plots/2.png' %}","{% static 'newsvendor/plots/3.png' %}","{% static 'newsvendor/plots/4.png' %}","{% static 'newsvendor/plots/5.png' %}",];
            // let imageNumber = 0;
            // change_image=function()
            // {
            //     imageNumber=(imageNumber+1)%pic.length;
            //     document.getElementById("plot").src=pic[imageNumber];
            // }
            var pattern=[];
            var week_no=[];
            var graph;

            var layout = {
                    title: 'Demand Pattern',
                    xaxis: {
                        title: 'Week '
                    },
                    yaxis: {
                        title: 'Demand'
                    }
                    };

            function plotGraph()
            {
                graph=Plotly.newPlot( 'plot', [{
                x: week_no,
                y: pattern }],layout );
            }
            calculate=function()
            {
                var t=document.getElementById('LB').value;
                var mean=document.getElementById('forecast').value;
                document.getElementById('UB').value=Math.round(Math.exp(2*Math.log(mean)-Math.log(t)));
            }

            show_cost=function()
            {
                // if(document.getElementById('even').style.display=='None'){
                    document.getElementById('even').style.display="block";
                // }
            }
            var user=new Object();


            document.addEventListener('DOMContentLoaded',()=>{
                var modal=document.getElementById('ethics');
                window.onclick=function(event){
                if(event.target==modal){
                    modal.style.display="none";
                }
                return false;
            }

            document.getElementById('firstsubmit').onclick=function(){

                user.email=document.getElementById('email').value;
                $.ajax(
                {
                    type:"GET",
                    url: "/decomposednv/checkEmail",
                    data:{
                             email: user.email,
                             gamename : 'Game 2'
                    },
                    success: function( data )
                    {
                        if(data=='False')
                        {
                            document.getElementById('first').style.display='none';
                            document.getElementById('second').style.display='block';
                        }
                        else
                        {
                            document.getElementById('email').value='';
                            alert("You have already taken the survey. ")
                        }
                    }
                 })
                return false;
            }


            document.getElementById('secondsubmit').onclick=function(){

                user.email=document.getElementById('email').value;
                user.name=document.getElementById("name").value;
                user.gender=document.getElementById('gender').value;

                if(document.getElementById('age').value != ""){user.age=document.getElementById('age').value;}else{user.age=0}
                user.organisation=document.getElementById('organisation').value;
                user.designation=document.getElementById('designation').value;
                user.gamename="Game 2";
                $.ajax(
                {
                    type:"GET",
                    url: "/decomposednv/userSubmit",
                    data:{
                            email:user.email,
                            name:user.name,
                            gender:user.gender,
                            age:user.age,
                            organisation:user.organisation,
                            designation:user.designation,
                            gamename:user.gamename,
                    },
                    success: function( data )
                    {
                            uid = data['uid'];
                            localStorage.setItem("uid", data['uid']);
                            currqid = data['qid'];
<!--                            values = data['data'];-->
<!--                            pattern=values;-->
<!--                            var w_no=[];-->
<!--                            for(i=1;i<=pattern.length;i++)-->
<!--                            {-->
<!--                                w_no.push(i);-->
<!--                            }-->
<!--                            week_no=w_no;-->
<!--                            document.getElementById('second').style.display='none';-->
<!--                            document.getElementById('third').style.display='block';-->
<!--                            document.getElementById('CU').innerHTML=data['CU'];-->
<!--                            document.getElementById('CO').innerHTML=data['CO'];-->
<!--                            document.getElementById('round').innerHTML=data['qid'];-->
<!--                           plotGraph();-->


                    }
                })

                 $.getJSON( "{% static 'newsvendor/DemandPattern.json' %}", function( data ) {

                            document.getElementById('second').style.display='none';
                            document.getElementById('third').style.display='block';
                            document.getElementById('CU').innerHTML=data[ArrLength]['Underage Cost'];
                            document.getElementById('CO').innerHTML=data[ArrLength]['Overage Cost'];
                            document.getElementById('round').innerHTML=roundIndex;
                            document.getElementById("meanValue").value = data[ArrLength]['Mean'];
                            document.getElementById("deviationValue").value = data[ArrLength]['Standard Deviation'];
                            var noOfWeeksArr = [];
                            var demandPatternArr = [];
                            for(var k in data[ArrLength]['Weeks']){
                                var weeks = data[ArrLength]['Weeks'][k];
                                var countWeeks = 1;
                                for (var key in weeks) {
                                     noOfWeeksArr.push(countWeeks)
                                     demandPatternArr.push(weeks[key])
                                     countWeeks++;
                                  }
                            }
                            pattern = demandPatternArr;
                            week_no=noOfWeeksArr;
                            plotGraph();
                            roundIndex++;
                            ArrLength++;
                });

                return false;
            }


            document.getElementById('roundSub').onclick=function(){

<!--                var question=new Object();-->
<!--                question.forecast=document.getElementById('forecast').value;-->
<!--                question.LB=document.getElementById('LB').value;-->
<!--                question.UB=document.getElementById('UB').value;-->
<!--                question.fill=document.getElementById('fill').value;-->
                var fillRate = $("#UB").val();

                if(fillRate != ""){
                $.getJSON( "{% static 'newsvendor/DemandPattern.json' %}", function( data ) {
                        if(ArrLength >19){
                            location.href="{% url 'newsvendor:roundOver2' %}"
                        }else{
                        document.getElementById('second').style.display='none';
                            document.getElementById('third').style.display='block';
                            document.getElementById('CU').innerHTML=data[ArrLength]['Underage Cost'];
                            document.getElementById('CO').innerHTML=data[ArrLength]['Overage Cost'];
                            document.getElementById('round').innerHTML=roundIndex;
                            $('#meanValue').val(data[ArrLength]['Mean']);
                            $('#deviationValue').val(data[ArrLength]['Standard Deviation']);

                            var noOfWeeksArr = [];
                            var demandPatternArr = [];
                            for(var k in data[ArrLength]['Weeks']){
                                var weeks = data[ArrLength]['Weeks'][k];
                                var countWeeks = 1;
                                for (var key in weeks) {
                                     noOfWeeksArr.push(countWeeks)
                                     demandPatternArr.push(weeks[key])
                                     countWeeks++;
                                  }
                            }
                            pattern = demandPatternArr;
                            week_no=noOfWeeksArr;
                            plotGraph();
                            roundIndex++;
                            ArrLength++;
                            $("#UB").val("");
                        }
                });

            }else{
            alert("Please enter fill rate")
            }



                $.ajax(
                {
                    type:"GET",
                    url: "/decomposednv/roundSubmit",
                    data:{
                        uid:uid,
                        qid:currqid,
                        point_forecast:$('#meanValue').val(),
                        LB:$('#deviationValue').val(),
                        UB:fillRate,
                        target_fill_rate:0
                    },
                    success: function( data )
                    {

                            currqid = data['qid'];
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown)
                    {
                        alert("Status: " + textStatus); alert("Error: " + errorThrown);
                    }
                })
                return false;
            }

            })


            var roundIndex = 1;
            var ArrLength = 0;
            var DemandPattern = [];
            $(document).ready( function () {
                getDemandPattern();
            });

            function getDemandPattern(){
                $.getJSON( "{% static 'newsvendor/DemandPattern.json' %}", function( data ) {
                DemandPattern = data;
                });
            }
        </script>
    </body>
</html>